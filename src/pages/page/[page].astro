---
import { getCollection } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import Main from "@layouts/Main.astro";
import Pagination from "@components/Pagination.astro";
import getSortedPosts from "@utils/getSortedPosts";
import { getPostExcerpt } from "@utils/getPostExcerpt";
import getPagination from "@utils/getPagination";
import { SITE } from "@config";

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = await getCollection("blog");
  const sortedPosts = getSortedPosts(posts);
  const POSTS_PER_PAGE = 5;
  const totalPages = Math.ceil(sortedPosts.length / POSTS_PER_PAGE);

  const paths = [];
  for (let i = 2; i <= totalPages; i++) {
    paths.push({
      params: { page: i.toString() },
      props: { 
        posts: sortedPosts,
        currentPage: i,
        totalPages: totalPages
      },
    });
  }

  return paths;
};

interface Props {
  posts: any[];
  currentPage: number;
  totalPages: number;
}

const { posts, currentPage, totalPages } = Astro.props;
const POSTS_PER_PAGE = 5;

function formatDate(date: Date): string {
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// 获取分页信息
const pagination = getPagination({
  posts: posts,
  page: currentPage,
  isIndex: false,
  postsPerPage: POSTS_PER_PAGE,
});

// 为每篇文章生成摘要
const postsWithExcerpts = pagination.paginatedPosts.map((post) => {
  const { excerpt, hasMore } = getPostExcerpt(post.body, 20);
  return {
    ...post,
    excerpt,
    hasMore
  };
});

const pageTitle = `${SITE.title} - 第 ${currentPage} 页`;
const pageDesc = `${SITE.desc} - 第 ${currentPage} 页`;
---

<Main pageTitle={pageTitle} pageDesc={pageDesc} activeNav="posts">
  {postsWithExcerpts.map((post) => (
    <article class="post">
      <date class="post-meta">
        {formatDate(new Date(post.data.pubDatetime))}
      </date>
      <header>
        <h2 class="post-title">
          <a href={`/posts/${post.slug}`}>{post.data.title}</a>
        </h2>
      </header>
      <div class="post-content">
        <div set:html={post.excerpt} />
        {post.hasMore && (
          <div class="more">
            <a href={`/posts/${post.slug}`}>阅读剩余部分 -</a>
          </div>
        )}
      </div>
    </article>
  ))}
  
  <Pagination {...pagination} />
</Main>