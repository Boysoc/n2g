---
import { getCollection } from "astro:content";
import getSortedPosts from "../utils/getSortedPosts";
import getUniqueCategories from "../utils/getUniqueCategories";
import getUniqueTags from "../utils/getUniqueTags";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const recentPosts = sortedPosts.slice(0, 5);
const uniqueCategories = getUniqueCategories(posts).slice(0, 8);
const uniqueTags = getUniqueTags(posts).slice(0, 12);
---

<div class="col-4" id="secondary">
  <div class="sidebar">
    <section class="widget">
      <form id="search" method="get" action="/search">
        <input type="text" name="q" class="text" placeholder="搜索..." />
        <button type="submit" class="submit icon-search">搜索</button>
      </form>
    </section>

    <section class="widget">
      <div class="widget-title">最新文章</div>
      <ul class="widget-list widget-list2">
        {recentPosts.map((post) => (
          <li>
            <h3>
              <a href={`/posts/${post.slug}`}>{post.data.title}</a>
            </h3>
          </li>
        ))}
      </ul>
    </section>

    <section class="widget">
      <div class="widget-title">标签</div>
      <div class="tag-cloud">
        {uniqueTags.map((tag) => (
          <a href={`/tags/${tag.tag}`} class="tag-link">{tag.tagName}</a>
        ))}
      </div>
    </section>

    <section class="widget">
      <div class="widget-title">分类</div>
      <div class="category-grid">
        {uniqueCategories.map((category) => (
          <a href={`/categories/${category.category}`} class="category-link">{category.categoryName}</a>
        ))}
      </div>
    </section>

    <section class="widget">
      <div class="widget-title">其它</div>
      <ul class="widget-list widget-list2">
        <li>
          <h3>
            <a href="/rss.xml">文章 RSS</a>
          </h3>
        </li>
        <li>
          <h3>
            <a href="/tags">标签云</a>
          </h3>
        </li>
      </ul>
    </section>
  </div>
</div>

<style>
  /* 基于原始 Navy 主题的 Sidebar 样式，添加移动端优化 */
  
  /* 桌面端样式 - 保持原有的 Navy 主题样式 */
  .col-4 {
    width: 300px;
  }
  
  /* 移动端优化的额外样式 */
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 15px 26px 0;
  }
  
  .tag-link {
    font-size: 0.85em;
    padding: 4px 8px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.1);
    color: #ccc;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .tag-link:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
  }
  
  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 8px;
    margin: 15px 26px 0;
  }
  
  .category-link {
    text-align: center;
    padding: 6px 8px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
    font-size: 0.85em;
    color: #ccc;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .category-link:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
  }
  
  /* 移动端优化 - 从右侧弹出 */
  @media (max-width: 768px) {
    #secondary {
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    #secondary.show {
      opacity: 1;
      visibility: visible;
    }
    
    .sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 280px;
      height: 100%;
      background: #303538;
      padding: 20px 0;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
    }
    
    #secondary.show .sidebar {
      transform: translateX(0);
    }
    
    .widget {
      margin-bottom: 25px;
    }
    
    .widget-title {
      margin: 15px 20px 0;
      font-size: 14px;
    }
    
    /* 搜索框移动端优化 */
    #search {
      padding: 0 20px;
      margin-bottom: 25px;
      margin-top: 20px;
    }
    
    #search input {
      width: 100%;
      margin-bottom: 8px;
      font-size: 16px; /* 防止iOS缩放 */
    }
    
    #search button {
      position: static;
      width: 100%;
      height: auto;
      padding: 8px;
      font-size: 16px;
    }
    
    /* 分类网格移动端优化 */
    .category-grid {
      grid-template-columns: repeat(2, 1fr);
      margin: 15px 20px 0;
      gap: 6px;
    }
    
    .category-link {
      padding: 8px 6px;
      font-size: 0.8em;
    }
    
    /* 标签云移动端优化 */
    .tag-cloud {
      margin: 15px 20px 0;
      gap: 6px;
    }
    
    .tag-link {
      font-size: 0.75em;
      padding: 4px 6px;
    }
    
    /* 列表移动端优化 */
    .widget-list h3 a {
      padding: .4em 20px;
      font-size: 12px;
    }
  }
  
  /* 小屏幕手机优化 */
  @media (max-width: 480px) {
    .sidebar {
      width: 260px;
    }
    
    .category-grid {
      grid-template-columns: 1fr;
    }
    
    .category-link {
      padding: 10px;
      font-size: 0.85em;
    }
  }
  
  /* 横屏手机优化 */
  @media (max-width: 768px) and (orientation: landscape) {
    .sidebar {
      width: 240px;
      padding: 15px 0;
    }
    
    .widget {
      margin-bottom: 15px;
    }
    
    .widget-title {
      margin: 10px 15px 0;
      font-size: 13px;
    }
    
    #search {
      padding: 0 15px;
    }
    
    .category-grid,
    .tag-cloud {
      margin: 10px 15px 0;
    }
  }
</style>

<script>
  // 移动端侧边栏控制
  document.addEventListener('DOMContentLoaded', function() {
    const secondary = document.getElementById('secondary');
    const sidebar = document.querySelector('.sidebar');
    
    // 点击遮罩层关闭侧边栏
    if (secondary) {
      secondary.addEventListener('click', function(e) {
        if (e.target === secondary) {
          secondary.classList.remove('show');
          document.body.style.overflow = '';
        }
      });
    }
    
    // ESC键关闭侧边栏
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && secondary && secondary.classList.contains('show')) {
        secondary.classList.remove('show');
        document.body.style.overflow = '';
      }
    });
    
    // 防止侧边栏内容点击时关闭
    if (sidebar) {
      sidebar.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }
  });
</script>