---
---

<div id="waline-comment"></div>

<script>
  // åŠ è½½Waline CSS
  function loadWalineCSS() {
    if (document.querySelector('link[href*="waline"]')) return;
    
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/@waline/client@v3/dist/waline.css';
    document.head.appendChild(link);
  }

  // åŠ¨æ€åŠ è½½Waline
  async function loadWaline() {
    // å…ˆåŠ è½½CSS
    loadWalineCSS();
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡
    if (window.WalineInit) {
      initWaline();
      return;
    }

    try {
      // åŠ¨æ€å¯¼å…¥Waline
      const { init } = await import('https://unpkg.com/@waline/client@v3/dist/waline.js');
      window.WalineInit = init;
      
      // ç­‰å¾…CSSåŠ è½½å®Œæˆ
      setTimeout(() => {
        initWaline();
      }, 800);
    } catch (error) {
      console.error('WalineåŠ è½½å¤±è´¥:', error);
      // å°è¯•å¤‡ç”¨CDN
      try {
        const { init } = await import('https://cdn.jsdelivr.net/npm/@waline/client@v3/dist/waline.js');
        window.WalineInit = init;
        setTimeout(() => {
          initWaline();
        }, 800);
      } catch (fallbackError) {
        console.error('å¤‡ç”¨CDNä¹Ÿå¤±è´¥:', fallbackError);
        const container = document.getElementById('waline-comment');
        if (container) {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">è¯„è®ºç³»ç»ŸåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢</p>';
        }
      }
    }
  }

  function initWaline() {
    const container = document.getElementById('waline-comment');
    if (!container || !window.WalineInit) {
      console.log('å®¹å™¨æˆ–Walineæœªå‡†å¤‡å¥½');
      return;
    }

    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';

    // è·å–å½“å‰ä¸»é¢˜
    const getCurrentTheme = () => {
      return document.documentElement.getAttribute('data-theme') || 'light';
    };

    const currentTheme = getCurrentTheme();
    console.log('åˆå§‹åŒ–Walineï¼Œå½“å‰ä¸»é¢˜:', currentTheme);

    try {
      console.log('å¼€å§‹åˆå§‹åŒ–Walineï¼ŒæœåŠ¡å™¨åœ°å€:', 'https://waline-comment-lovat-phi.vercel.app');
      console.log('å½“å‰é¡µé¢è·¯å¾„:', window.location.pathname);
      
      // åˆå§‹åŒ–Waline
      const waline = window.WalineInit({
        el: '#waline-comment',
        serverURL: 'https://waline-comment-lovat-phi.vercel.app',
        path: window.location.pathname,
        placeholder: 'è¯·ç•™ä¸‹ä½ çš„è¶³è¿¹~',
        avatar: 'monsterid',
        meta: ['nick', 'mail', 'link'],
        requiredMeta: ['nick'],
        login: 'disable',
        wordLimit: 0,
        pageSize: 10,
        lang: 'zh-CN',
        locale: {
          seconds: 'åˆšåˆš',
          minutes: '$0 åˆ†é’Ÿå‰',
          hours: '$0 å°æ—¶å‰',
          days: '$0 å¤©å‰',
          now: 'åˆšåˆš',
          sofa: 'æ¥å‘è¯„è®ºå§~',
          submit: 'æäº¤',
          reply: 'å›å¤',
          cancelReply: 'å–æ¶ˆå›å¤',
          comment: 'è¯„è®º',
          refresh: 'åˆ·æ–°',
          more: 'åŠ è½½æ›´å¤š...',
          preview: 'é¢„è§ˆ',
          emoji: 'è¡¨æƒ…'
        },
        dark: currentTheme === 'dark',
        emoji: [
          'https://unpkg.com/@waline/emojis@1.2.0/weibo'
        ],
        imageUploader: false,
        copyright: false,
        reaction: false
      });

      console.log('Walineåˆå§‹åŒ–æˆåŠŸ');

      // è‡ªå®šä¹‰æ—¶é—´æ ¼å¼åŒ–
      setTimeout(() => {
        const timeElements = document.querySelectorAll('.wl-time');
        timeElements.forEach(timeEl => {
          const originalTime = timeEl.textContent;
          if (originalTime) {
            // å¦‚æœæ˜¯ç›¸å¯¹æ—¶é—´ï¼Œä¿æŒåŸæ ·
            if (originalTime.includes('å‰') || originalTime === 'åˆšåˆš') {
              return;
            }
            
            // å¦‚æœæ˜¯ç»å¯¹æ—¶é—´ï¼Œæ ¼å¼åŒ–ä¸ºæ›´æ¼‚äº®çš„æ ¼å¼
            try {
              const date = new Date(timeEl.getAttribute('datetime') || timeEl.textContent);
              const now = new Date();
              const diffMs = now.getTime() - date.getTime();
              const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
              
              if (diffDays === 0) {
                timeEl.textContent = 'ä»Šå¤©';
              } else if (diffDays === 1) {
                timeEl.textContent = 'æ˜¨å¤©';
              } else if (diffDays === 2) {
                timeEl.textContent = 'å‰å¤©';
              } else if (diffDays < 7) {
                timeEl.textContent = `${diffDays} å¤©å‰`;
              } else {
                // è¶…è¿‡ä¸€å‘¨æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
                const month = date.getMonth() + 1;
                const day = date.getDate();
                timeEl.textContent = `${month}æœˆ${day}æ—¥`;
              }
            } catch (e) {
              // å¦‚æœè§£æå¤±è´¥ï¼Œä¿æŒåŸæ ·
            }
          }
        });
      }, 1000);

      // ç›‘å¬ä¸»é¢˜å˜åŒ–
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
            const newTheme = getCurrentTheme();
            console.log('ä¸»é¢˜åˆ‡æ¢åˆ°:', newTheme);
            
            // é‡æ–°åˆå§‹åŒ–Walineä»¥åº”ç”¨æ–°ä¸»é¢˜
            setTimeout(() => {
              initWaline();
            }, 100);
          }
        });
      });

      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme']
      });

      return waline;
    } catch (error) {
      console.error('Walineåˆå§‹åŒ–å¤±è´¥:', error);
      container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">è¯„è®ºç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥</p>';
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadWaline);
  } else {
    loadWaline();
  }

  // Astroé¡µé¢åˆ‡æ¢æ—¶é‡æ–°åˆå§‹åŒ–
  document.addEventListener('astro:page-load', () => {
    setTimeout(loadWaline, 100);
  });

  document.addEventListener('astro:after-swap', () => {
    setTimeout(loadWaline, 100);
  });
</script>

<style>
  #waline-comment {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
  }

  /* åŸºç¡€æ ·å¼é€‚é… */
  :global(.wl-container) {
    font-family: inherit !important;
    color: var(--text-color) !important;
    max-width: 100% !important;
  }

  :global(.wl-editor) {
    background-color: var(--bg-color) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 6px !important;
    color: var(--text-color) !important;
    font-family: inherit !important;
    padding: 12px !important;
    font-size: 14px !important;
    line-height: 1.5 !important;
    min-height: 80px !important;
    resize: vertical !important;
  }

  :global(.wl-editor:focus) {
    border-color: var(--link-color) !important;
    outline: none !important;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25) !important;
  }

  /* ä¿®å¤å­—æ•°ç»Ÿè®¡æ˜¾ç¤º */
  :global(.wl-count) {
    color: var(--text-color) !important;
    font-size: 12px !important;
    margin: 8px 0 !important;
    text-align: right !important;
    opacity: 0.7 !important;
    display: block !important;
    visibility: visible !important;
  }

  /* ç¡®ä¿å­—æ•°ç»Ÿè®¡å®¹å™¨æ­£ç¡®æ˜¾ç¤º */
  :global(.wl-num) {
    display: inline !important;
    color: var(--text-color) !important;
    opacity: 0.7 !important;
    font-size: 12px !important;
  }

  /* ä¿®å¤å­—æ•°ç»Ÿè®¡åœ¨ä¸åŒæµè§ˆå™¨çš„å…¼å®¹æ€§ */
  :global(.wl-editor-wrapper) {
    position: relative !important;
  }

  :global(.wl-editor-wrapper .wl-count) {
    position: absolute !important;
    bottom: -20px !important;
    right: 0 !important;
    font-size: 11px !important;
    color: var(--text-color) !important;
    opacity: 0.6 !important;
  }

  /* ä¿®å¤è¾“å…¥æ¡†åŒºåŸŸ */
  :global(.wl-input) {
    background-color: var(--bg-color) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 4px !important;
    color: var(--text-color) !important;
    padding: 6px 8px !important;
    font-size: 13px !important;
    font-family: inherit !important;
  }

  :global(.wl-input:focus) {
    border-color: var(--link-color) !important;
    outline: none !important;
  }

  /* ä¿®å¤å¤´åƒå’Œç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
  :global(.wl-header) {
    display: flex !important;
    align-items: flex-start !important;
    gap: 12px !important;
    margin-bottom: 12px !important;
  }

  :global(.wl-avatar) {
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important;
  }

  /* ä¿®å¤è¡¨å•åŒºåŸŸ */
  :global(.wl-panel) {
    background-color: var(--card-bg) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    padding: 16px !important;
    margin-bottom: 20px !important;
  }

  :global(.wl-btn) {
    background-color: var(--text-color) !important;
    color: var(--bg-color) !important;
    border: none !important;
    border-radius: 4px !important;
    padding: 8px 16px !important;
    font-size: 14px !important;
    font-family: inherit !important;
    transition: opacity 0.2s ease !important;
    cursor: pointer !important;
  }

  :global(.wl-btn:hover) {
    opacity: 0.8 !important;
  }

  :global(.wl-btn:disabled) {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
  }

  :global(.wl-card) {
    background-color: var(--card-bg) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    box-shadow: 0 1px 3px var(--shadow-color) !important;
    margin-bottom: 1rem !important;
    padding: 1rem !important;
  }

  :global(.wl-nick) {
    color: var(--heading-color) !important;
    font-weight: 600 !important;
    font-size: 14px !important;
  }

  :global(.wl-time) {
    color: var(--text-color) !important;
    opacity: 0.6 !important;
    font-size: 12px !important;
    font-weight: 400 !important;
    margin-left: 8px !important;
    position: relative !important;
  }

  /* ç¾åŒ–æ—¶é—´æ˜¾ç¤º */
  :global(.wl-time::before) {
    content: "ğŸ“… " !important;
    opacity: 0.5 !important;
    margin-right: 2px !important;
  }

  /* æ—¶é—´æ‚¬åœæ•ˆæœ */
  :global(.wl-time:hover) {
    opacity: 0.9 !important;
    transition: opacity 0.2s ease !important;
  }

  /* ç›¸å¯¹æ—¶é—´æ ·å¼ */
  :global(.wl-time[title]) {
    cursor: help !important;
    border-bottom: 1px dotted var(--text-color) !important;
    border-opacity: 0.3 !important;
  }

  :global(.wl-content) {
    color: var(--text-color) !important;
    line-height: 1.6 !important;
    margin-top: 0.5rem !important;
    font-size: 14px !important;
  }

  :global(.wl-content p) {
    margin: 0.5rem 0 !important;
  }

  :global(.wl-meta) {
    border-top: 1px solid var(--border-color) !important;
    padding-top: 0.5rem !important;
    margin-top: 0.5rem !important;
  }

  :global(.wl-count) {
    color: var(--text-color) !important;
    font-size: 14px !important;
    margin-bottom: 1rem !important;
  }

  :global(.wl-loading) {
    text-align: center !important;
    padding: 2rem !important;
    color: var(--text-color) !important;
    opacity: 0.7 !important;
  }

  :global(.wl-empty) {
    text-align: center !important;
    padding: 2rem !important;
    color: var(--text-color) !important;
    opacity: 0.7 !important;
  }

  /* æ·±è‰²ä¸»é¢˜é€‚é… */
  [data-theme="dark"] :global(.wl-editor) {
    background-color: var(--card-bg) !important;
    border-color: var(--border-color) !important;
    color: var(--text-color) !important;
  }

  [data-theme="dark"] :global(.wl-card) {
    background-color: var(--card-bg) !important;
    border-color: var(--border-color) !important;
  }

  [data-theme="dark"] :global(.wl-btn) {
    background-color: var(--text-color) !important;
    color: var(--bg-color) !important;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    #waline-comment {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }

    :global(.wl-container) {
      padding: 0 !important;
      margin: 0 !important;
      max-width: 100% !important;
    }

    :global(.wl-editor) {
      font-size: 14px !important;
      padding: 10px !important;
      min-height: 60px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    :global(.wl-panel) {
      padding: 12px !important;
      margin: 0 0 15px 0 !important;
      border-radius: 6px !important;
    }

    :global(.wl-header) {
      flex-direction: column !important;
      gap: 8px !important;
    }

    :global(.wl-header-item) {
      width: 100% !important;
      margin-bottom: 8px !important;
    }

    :global(.wl-input) {
      width: 100% !important;
      margin-bottom: 8px !important;
      padding: 8px !important;
      font-size: 14px !important;
      box-sizing: border-box !important;
    }

    :global(.wl-btn) {
      padding: 8px 16px !important;
      font-size: 14px !important;
      width: auto !important;
      margin: 5px 5px 5px 0 !important;
    }

    :global(.wl-card) {
      padding: 12px !important;
      margin-bottom: 12px !important;
      border-radius: 6px !important;
    }

    :global(.wl-avatar) {
      width: 32px !important;
      height: 32px !important;
    }

    :global(.wl-nick) {
      font-size: 13px !important;
    }

    :global(.wl-time) {
      font-size: 11px !important;
      margin-left: 0 !important;
      margin-top: 4px !important;
      display: block !important;
    }

    :global(.wl-content) {
      font-size: 13px !important;
      line-height: 1.5 !important;
      word-break: break-word !important;
    }

    :global(.wl-meta) {
      flex-wrap: wrap !important;
      gap: 8px !important;
    }

    :global(.wl-count) {
      font-size: 11px !important;
      text-align: left !important;
      margin: 5px 0 !important;
    }

    /* ä¿®å¤è¾“å…¥æ¡†å¸ƒå±€ */
    :global(.wl-info) {
      display: flex !important;
      flex-direction: column !important;
      gap: 8px !important;
      margin-bottom: 12px !important;
    }

    :global(.wl-info .wl-input) {
      flex: none !important;
      width: 100% !important;
    }

    /* ä¿®å¤æŒ‰é’®åŒºåŸŸ */
    :global(.wl-actions) {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 8px !important;
      justify-content: flex-start !important;
    }

    /* ä¿®å¤è¡¨æƒ…å’Œå·¥å…·æ  */
    :global(.wl-emoji) {
      max-width: 100% !important;
      overflow-x: auto !important;
    }

    :global(.wl-tabs) {
      flex-wrap: wrap !important;
    }
  }

  /* è¶…å°å±å¹•ä¼˜åŒ– */
  @media (max-width: 480px) {
    #waline-comment {
      margin-top: 1rem;
      padding-top: 1rem;
    }

    :global(.wl-editor) {
      min-height: 50px !important;
      font-size: 13px !important;
      padding: 8px !important;
    }

    :global(.wl-panel) {
      padding: 10px !important;
    }

    :global(.wl-btn) {
      padding: 6px 12px !important;
      font-size: 13px !important;
    }

    :global(.wl-card) {
      padding: 10px !important;
    }

    :global(.wl-content) {
      font-size: 12px !important;
    }
  }
</style>